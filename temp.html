param (
    [string]$Template = "template_name",
    [string]$Domain = "domain_name"
)

# --- Настройки ---
$DnsName = @(
    "service_name.${Domain}",
    "another_service_name.${Domain}"
)
$SubjectName   = "CN=service_name.${Domain}"
$StoreLocation = "Cert:\LocalMachine\My"

# --- Основной код ---
try {
    Write-Log "Starting a certificate request for ${DnsName} using a template ${Template}"

    $params = @{
        Template          = $Template
        DnsName           = $DnsName
        SubjectName       = $SubjectName
        CertStoreLocation = $StoreLocation
	Url               = "ldap:"  
    }

    $enrollResult = Get-Certificate @params -ErrorAction Stop

    if ($enrollResult.Status -eq "Issued") {
        Write-Host "[SUCCESS] The certificate has been issued and installed: $($enrollResult.Certificate.Subject)" -ForegroundColor Green
        Write-Log "Success: Certificate installed (Subject: $($enrollResult.Certificate.Subject))"
    }
    elseif ($enrollResult.Status -eq "Pending") {
        $requestId = $enrollResult.Request.RequestID
        Write-Host "[PENDING] Request sent, awaiting approval. ID: ${requestId}" -ForegroundColor Yellow
        Write-Log "Pending approval. Request ID: ${requestId}"
    }
    else {
        $errorMsg = $enrollResult.ErrorMessage -join "; "
        Write-Host "[ERROR] Issue error: ${errorMsg}" -ForegroundColor Red
        Write-Log "Error: ${errorMsg}"
    }
}

catch {
    $errorMessage = $_.Exception.Message
    Write-Host "[ERROR] Exception: ${errorMessage}" -ForegroundColor Red
    Write-Log "Exception: ${errorMessage}"
    exit 1
}

# --- Завершение ---
Write-Log "Execution completed"
Write-Host "Log saved: ${LogFile}" -ForegroundColor Cyan
