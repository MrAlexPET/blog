from django.utils import timezone
from datetime import timedelta
from django.db.models import Count
from certificates.models import Certificate


def certificates_expiring_stats():
    now = timezone.now()

    return {
        "expired": Certificate.objects.filter(expires_at__lt=now).count(),
        "days_0_7": Certificate.objects.filter(
            expires_at__gte=now,
            expires_at__lte=now + timedelta(days=7)
        ).count(),
        "days_8_30": Certificate.objects.filter(
            expires_at__gt=now + timedelta(days=7),
            expires_at__lte=now + timedelta(days=30)
        ).count(),
        "days_31_90": Certificate.objects.filter(
            expires_at__gt=now + timedelta(days=30),
            expires_at__lte=now + timedelta(days=90)
        ).count(),
        "days_90_plus": Certificate.objects.filter(
            expires_at__gt=now + timedelta(days=90)
        ).count(),
    }
