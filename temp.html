import subprocess
from datetime import datetime
from certificates.models import Certificate


CERTUTIL_CMD = [
    "certutil",
    "-view",
    "-restrict", "Disposition=20",
    "-out", "SerialNumber,CommonName,CertificateTemplate,NotBefore,NotAfter"
]


def sync_certificates():
    result = subprocess.run(
        CERTUTIL_CMD,
        capture_output=True,
    )

    text = result.stdout.decode("cp866", errors="ignore")

    saved = 0
    current = {}

    for line in text.splitlines():
        if ":" not in line:
            continue

        key, value = line.split(":", 1)
        key = key.strip()
        value = value.strip()

        if key == "SerialNumber":
            current["serial"] = value
        elif key == "CommonName":
            current["cn"] = value
        elif key == "CertificateTemplate":
            current["template"] = value
        elif key == "NotBefore":
            current["issued"] = value
        elif key == "NotAfter":
            current["expires"] = value

        if len(current) == 5:
            Certificate.objects.update_or_create(
                serial_number=current["serial"],
                defaults={
                    "common_name": current["cn"],
                    "template_name": current["template"],
                    "issued_at": datetime.strptime(current["issued"], "%d.%m.%Y %H:%M"),
                    "expires_at": datetime.strptime(current["expires"], "%d.%m.%Y %H:%M"),
                    "san": "",
                }
            )
            saved += 1
            current = {}

    print(f"âœ” Saved {saved} certificates")
