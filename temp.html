server.py:
import socket
import threading
import struct
import mss
from PIL import Image
import io
import time
from pynput.mouse import Controller as MouseController, Button
from pynput.keyboard import Controller as KeyboardController, Key
import json

HOST = "0.0.0.0"
PORT = 5000

client_connected = False

mouse = MouseController()
keyboard = KeyboardController()


def receive_commands(conn):
    while True:
        header = conn.recv(1)
        if not header:
            break

        packet_type = struct.unpack("B", header)[0]

        size_data = conn.recv(4)
        size = struct.unpack(">I", size_data)[0]

        data = conn.recv(size)
        message = json.loads(data.decode())

        if packet_type == 2:  # движение мыши
            mouse.position = (message["x"], message["y"])

        elif packet_type == 3:  # клик
            if message["action"] == "down":
                mouse.press(Button.left)
            else:
                mouse.release(Button.left)

        elif packet_type == 4:  # клавиша
            key = message["key"]
            keyboard.press(key)
            keyboard.release(key)


def handle_client(conn):
    global client_connected
    with mss.mss() as sct:
        monitor = sct.monitors[1]

        try:
            while True:
                screenshot = sct.grab(monitor)
                img = Image.frombytes("RGB", screenshot.size, screenshot.rgb)

                buffer = io.BytesIO()
                img.save(buffer, format="JPEG", quality=60)
                data = buffer.getvalue()

                # Отправляем размер кадра (4 байта)
                conn.sendall(struct.pack(">I", len(data)))
                # Отправляем сам кадр
                conn.sendall(data)

                time.sleep(0.03)  # ~30 FPS
        except:
            print("Клиент отключился")

    threading.Thread(target=receive_commands, args=(conn,), daemon=True).start()

    conn.close()
    client_connected = False


def start_server():
    global client_connected
    server = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    server.bind((HOST, PORT))
    server.listen(1)

    print(f"Сервер запущен на порту {PORT}")

    while True:
        conn, addr = server.accept()

        if client_connected:
            print("Попытка второго подключения — отклонено")
            conn.close()
            continue

        print(f"Подключен клиент: {addr}")
        client_connected = True

        threading.Thread(target=handle_client, args=(conn,), daemon=True).start()


if __name__ == "__main__":
    start_server()


client.py:
import socket
import struct
import tkinter as tk
from PIL import Image, ImageTk
import io
import threading
import json

SERVER_IP = "169.254.36.5"
PORT = 5000


class RemoteClient:
    def __init__(self, root):
        self.root = root
        self.root.title("Remote Desktop")
        self.label = tk.Label(root)
        self.label.pack()

        self.sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        self.sock.connect((SERVER_IP, PORT))

        self.label.bind("<Motion>", self.on_mouse_move)
        self.label.bind("<ButtonPress-1>", self.on_mouse_click)
        self.label.bind("<ButtonRelease-1>", self.on_mouse_release)

        self.root.bind("<KeyPress>", self.on_key_press)

        threading.Thread(target=self.receive_video, daemon=True).start()

    def receive_video(self):
        try:
            while True:
                size_data = self.recvall(4)
                size = struct.unpack(">I", size_data)[0]

                frame_data = self.recvall(size)
                image = Image.open(io.BytesIO(frame_data))

                photo = ImageTk.PhotoImage(image)

                self.label.config(image=photo)
                self.label.image = photo
        except:
            print("Соединение закрыто")

    def recvall(self, size):
        data = b""
        while len(data) < size:
            packet = self.sock.recv(size - len(data))
            if not packet:
                return None
            data += packet
        return data

    def send_packet(self, packet_type, data_dict):
        data = json.dumps(data_dict).encode()
        self.sock.sendall(struct.pack("B", packet_type))
        self.sock.sendall(struct.pack(">I", len(data)))
        self.sock.sendall(data)

    def on_mouse_move(self, event):
        self.send_packet(2, {"x": event.x, "y": event.y})

    def on_mouse_click(self, event):
        self.send_packet(3, {"action": "down"})

    def on_mouse_release(self, event):
        self.send_packet(3, {"action": "up"})

    def on_key_press(self, event):
        self.send_packet(4, {"key": event.char})


if __name__ == "__main__":
    root = tk.Tk()
    app = RemoteClient(root)
    root.mainloop()
