from django.shortcuts import render, redirect, get_object_or_404
from django.utils import timezone
from django.contrib import messages
from django.db.models import Q, Count
from django.contrib.auth.decorators import login_required
from datetime import timedelta
from .models import Certificate
from certificates.services.adcs import sync_certificates


def apply_filters(certificates, request):
    """Применяет фильтры поиска и фильтрации к queryset"""
    search = request.GET.get("search")
    template = request.GET.get("template")
    status = request.GET.get("status")
    now = timezone.now()

    if search:
        certificates = certificates.filter(
            Q(common_name__icontains=search) |
            Q(serial_number__icontains=search) |
            Q(san__icontains=search)
        )

    if template:
        certificates = certificates.filter(template_name=template)

    if status == "active":
        certificates = certificates.filter(expires_at__gt=now, revoked=False)
    elif status == "expiring":
        certificates = certificates.filter(
            expires_at__gt=now,
            expires_at__lte=now + timedelta(days=30),
            revoked=False
        )
    elif status == "expired":
        certificates = certificates.filter(expires_at__lt=now)
    elif status == "revoked":
        certificates = certificates.filter(revoked=True)

    return certificates


@login_required
def certificate_list(request):
    certificates = Certificate.objects.all().order_by('expires_at')

    search = request.GET.get("search")
    template = request.GET.get("template")
    status = request.GET.get("status")

    if search:
        certificates = certificates.filter(
            Q(common_name__icontains=search) |
            Q(serial_number__icontains=search) |
            Q(san__icontains=search)
        )

    if template:
        certificates = certificates.filter(template_name=template)

    now = timezone.now()

    if status == "active":
        certificates = certificates.filter(expires_at__gt=now, revoked=False)

    elif status == "expiring":
        certificates = certificates.filter(
            expires_at__gt=now,
            expires_at__lte=now + timezone.timedelta(days=30),
            revoked=False
        )

    elif status == "expired":
        certificates = certificates.filter(expires_at__lt=now)

    elif status == "revoked":
        certificates = certificates.filter(revoked=True)

    templates = Certificate.objects.values_list(
        "template_name", flat=True
    ).distinct()

    return render(request, "certificates/list.html", {
        "certificates": certificates,
        "templates": templates
    })


@login_required
def dashboard(request):
    now = timezone.now()

    total = Certificate.objects.count()
    active = Certificate.objects.filter(
        revoked=False,
        expires_at__gt=now
    ).count()
    print(active)

    expiring = Certificate.objects.filter(
        revoked=False,
        expires_at__gt=now,
        expires_at__lte=now + timezone.timedelta(days=30)
    ).count()

    expired = Certificate.objects.filter(
        expires_at__lte=now
    ).count()

    revoked = Certificate.objects.filter(revoked=True).count()

    templates = (
        Certificate.objects
        .values("template_name")
        .annotate(total=Count("id"))
        .order_by("-total")[:5]
    )

    stats = certificates_expiring_stats()

    context = {
        "total": total,
        "active": active,
        "expiring": expiring,
        "expired": expired,
        "revoked": revoked,
        "templates": templates,
        "stats": stats,
    }

    return render(request, "certificates/dashboard.html", context)


def certificates_expiring_stats():
    now = timezone.now()

    qs = Certificate.objects.filter(revoked=False)

    return {
        "expired": qs.filter(expires_at__lt=now).count(),
        "days_0_7": qs.filter(
            expires_at__gte=now,
            expires_at__lte=now + timedelta(days=7)
        ).count(),
        "days_8_30": qs.filter(
            expires_at__gt=now + timedelta(days=7),
            expires_at__lte=now + timedelta(days=30)
        ).count(),
        "days_31_90": qs.filter(
            expires_at__gt=now + timedelta(days=30),
            expires_at__lte=now + timedelta(days=90)
        ).count(),
        "days_90_plus": qs.filter(
            expires_at__gt=now + timedelta(days=90)
        ).count(),
    }


@login_required
def certificates_active(request):
    now = timezone.now()
    base_qs = Certificate.objects.filter(revoked=False, expires_at__gt=now)
    filtered_qs = apply_filters(base_qs, request)

    templates = Certificate.objects.values_list("template_name", flat=True).distinct()

    return render(request, "certificates/list.html", {
        "certificates": filtered_qs,
        "templates": templates,
        "title": "Active certificates",
        "search": request.GET.get("search", ""),
        "selected_template": request.GET.get("template", ""),
        "selected_status": request.GET.get("status", ""),
    })


@login_required
def certificates_expiring(request):
    now = timezone.now()
    base_qs = Certificate.objects.filter(
        revoked=False,
        expires_at__gt=now,
        expires_at__lte=now + timedelta(days=30)
    )
    filtered_qs = apply_filters(base_qs, request)

    templates = Certificate.objects.values_list("template_name", flat=True).distinct()

    return render(request, "certificates/list.html", {
        "certificates": filtered_qs,
        "templates": templates,
        "title": "Expiring soon",
        "search": request.GET.get("search", ""),
        "selected_template": request.GET.get("template", ""),
        "selected_status": request.GET.get("status", ""),
    })


@login_required
def certificates_expired(request):
    now = timezone.now()
    base_qs = Certificate.objects.filter(expires_at__lte=now)
    filtered_qs = apply_filters(base_qs, request)

    templates = Certificate.objects.values_list("template_name", flat=True).distinct()

    return render(request, "certificates/list.html", {
        "certificates": filtered_qs,
        "templates": templates,
        "title": "Expired certificates",
        "search": request.GET.get("search", ""),
        "selected_template": request.GET.get("template", ""),
        "selected_status": request.GET.get("status", ""),
    })


@login_required
def certificates_revoked(request):
    base_qs = Certificate.objects.filter(revoked=True)
    filtered_qs = apply_filters(base_qs, request)

    templates = Certificate.objects.values_list("template_name", flat=True).distinct()

    return render(request, "certificates/list.html", {
        "certificates": filtered_qs,
        "templates": templates,
        "title": "Revoked certificates",
        "search": request.GET.get("search", ""),
        "selected_template": request.GET.get("template", ""),
        "selected_status": request.GET.get("status", ""),
    })


@login_required
def sync_certificates_views(request):
    if request.method == "POST":
        sync_certificates()
        messages.success(request, "Certificates successfully synced from AD CS")

    return redirect(request.META.get("HTTP_REFERER", "/"))


@login_required
def certificate_detail(request, serial):
    cert = get_object_or_404(Certificate, serial_number=serial)
    return render(request, 'certificates/detail.html', {'cert': cert})


@login_required
def templates_list(request):
    templates = (
        Certificate.objects
        .values("template_name")
        .annotate(total=Count("id"))
        .order_by("template_name")
    )

    return render(
        request,
        "certificates/groups/templates_list.html",
        {"templates": templates},
    )


@login_required
def certificates_by_template(request, template_name):
    base_qs = Certificate.objects.filter(template_name=template_name)

    filtered_qs = apply_filters(base_qs, request)

    templates = Certificate.objects.values_list("template_name", flat=True).distinct()

    return render(
        request,
        "certificates/list.html",
        {
            "certificates": filtered_qs,
            "templates": templates,
            "current_template": template_name,
            "search": request.GET.get("search", ""),
            "selected_template": request.GET.get("template", ""),
            "selected_status": request.GET.get("status", ""),
        },
    )


@login_required
def vms_list(request):
    vms = (
        Certificate.objects
        .exclude(vm="")
        .values("vm")
        .annotate(total=Count("id"))
        .order_by("vm")
    )

    return render(
        request,
        "certificates/groups/vms_list.html",
        {"vms": vms}
    )


@login_required
def certificates_by_vm(request, vm_name):
    certificates = Certificate.objects.filter(vm=vm_name)

    return render(
        request,
        "certificates/list.html",
        {
            "certificates": certificates,
            "current_vm": vm_name,
        },
    )
